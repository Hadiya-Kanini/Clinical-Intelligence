namespace ClinicalIntelligence.Api.Services.Security;

/// <summary>
/// Result of a malware scan operation.
/// </summary>
public record MalwareScanResult
{
    /// <summary>File is clean (no malware detected).</summary>
    public bool IsClean { get; init; }

    /// <summary>Malware was detected in the file.</summary>
    public bool IsMalwareDetected { get; init; }

    /// <summary>Name of the detected threat (e.g., "Trojan.GenericKD.12345").</summary>
    public string? ThreatName { get; init; }

    /// <summary>Type/category of the threat (e.g., "Trojan", "Virus", "Worm").</summary>
    public string? ThreatType { get; init; }

    /// <summary>Name of the scanner that performed the scan.</summary>
    public string ScannerName { get; init; } = string.Empty;

    /// <summary>Duration of the scan operation.</summary>
    public TimeSpan ScanDuration { get; init; }

    /// <summary>Error message if scan failed.</summary>
    public string? ErrorMessage { get; init; }

    /// <summary>Indicates if the scan completed successfully (regardless of result).</summary>
    public bool ScanCompleted { get; init; } = true;

    /// <summary>Indicates if the scanner timed out.</summary>
    public bool TimedOut { get; init; }

    /// <summary>
    /// Creates a result indicating a clean file.
    /// </summary>
    public static MalwareScanResult Clean(string scannerName, TimeSpan duration) => new()
    {
        IsClean = true,
        IsMalwareDetected = false,
        ScannerName = scannerName,
        ScanDuration = duration,
        ScanCompleted = true
    };

    /// <summary>
    /// Creates a result indicating malware was detected.
    /// </summary>
    public static MalwareScanResult MalwareFound(string scannerName, string threatName, string? threatType, TimeSpan duration) => new()
    {
        IsClean = false,
        IsMalwareDetected = true,
        ThreatName = threatName,
        ThreatType = threatType,
        ScannerName = scannerName,
        ScanDuration = duration,
        ScanCompleted = true
    };

    /// <summary>
    /// Creates a result indicating the scan failed.
    /// </summary>
    public static MalwareScanResult Error(string scannerName, string errorMessage, TimeSpan duration) => new()
    {
        IsClean = false,
        IsMalwareDetected = false,
        ScannerName = scannerName,
        ScanDuration = duration,
        ErrorMessage = errorMessage,
        ScanCompleted = false
    };

    /// <summary>
    /// Creates a result indicating the scan timed out.
    /// </summary>
    public static MalwareScanResult Timeout(string scannerName, TimeSpan duration) => new()
    {
        IsClean = false,
        IsMalwareDetected = false,
        ScannerName = scannerName,
        ScanDuration = duration,
        ErrorMessage = "Scan timed out",
        ScanCompleted = false,
        TimedOut = true
    };
}

/// <summary>
/// Interface for malware scanning abstraction.
/// Follows ISP (Interface Segregation Principle) - focused interface for scanning.
/// </summary>
public interface IMalwareScanner
{
    /// <summary>
    /// Scans a file stream for malware.
    /// </summary>
    /// <param name="fileStream">Stream containing the file content.</param>
    /// <param name="fileName">Original filename for logging purposes.</param>
    /// <param name="ct">Cancellation token.</param>
    /// <returns>Scan result indicating if malware was detected.</returns>
    Task<MalwareScanResult> ScanAsync(Stream fileStream, string fileName, CancellationToken ct = default);

    /// <summary>
    /// Indicates if the scanner is available and properly configured.
    /// </summary>
    bool IsAvailable { get; }

    /// <summary>
    /// Name of the scanner implementation.
    /// </summary>
    string ScannerName { get; }
}
