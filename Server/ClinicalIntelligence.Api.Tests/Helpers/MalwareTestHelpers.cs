using System.Text;
using ClinicalIntelligence.Api.Services.Security;
using Moq;

namespace ClinicalIntelligence.Api.Tests.Helpers;

/// <summary>
/// Helper class for malware scanning tests.
/// Provides EICAR test file generation and mock scanner factories.
/// </summary>
public static class MalwareTestHelpers
{
    /// <summary>
    /// EICAR test string - standard antivirus test pattern.
    /// This is a safe test file that all antivirus software should detect.
    /// </summary>
    public const string EicarTestString = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*";

    /// <summary>
    /// Creates an EICAR test file as byte array.
    /// </summary>
    public static byte[] CreateEicarTestFile()
    {
        return Encoding.ASCII.GetBytes(EicarTestString);
    }

    /// <summary>
    /// Creates a stream containing the EICAR test file.
    /// </summary>
    public static Stream CreateEicarTestStream()
    {
        return new MemoryStream(CreateEicarTestFile());
    }

    /// <summary>
    /// Creates a minimal valid PDF content for clean file testing.
    /// </summary>
    public static Stream CreateCleanPdfStream()
    {
        var pdfContent = @"%PDF-1.4
1 0 obj
<< /Type /Catalog /Pages 2 0 R >>
endobj
2 0 obj
<< /Type /Pages /Kids [3 0 R] /Count 1 >>
endobj
3 0 obj
<< /Type /Page /Parent 2 0 R /MediaBox [0 0 612 792] >>
endobj
xref
0 4
0000000000 65535 f 
0000000009 00000 n 
0000000058 00000 n 
0000000115 00000 n 
trailer
<< /Size 4 /Root 1 0 R >>
startxref
190
%%EOF";
        return new MemoryStream(Encoding.ASCII.GetBytes(pdfContent));
    }

    /// <summary>
    /// Creates a mock scanner that returns clean results.
    /// </summary>
    public static Mock<IMalwareScanner> CreateMockCleanScanner()
    {
        var mock = new Mock<IMalwareScanner>();
        mock.Setup(s => s.IsAvailable).Returns(true);
        mock.Setup(s => s.ScannerName).Returns("MockScanner");
        mock.Setup(s => s.ScanAsync(It.IsAny<Stream>(), It.IsAny<string>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(MalwareScanResult.Clean("MockScanner", TimeSpan.FromMilliseconds(100)));
        return mock;
    }

    /// <summary>
    /// Creates a mock scanner that detects malware.
    /// </summary>
    public static Mock<IMalwareScanner> CreateMockInfectedScanner(string threatName = "Test.Malware", string threatType = "Trojan")
    {
        var mock = new Mock<IMalwareScanner>();
        mock.Setup(s => s.IsAvailable).Returns(true);
        mock.Setup(s => s.ScannerName).Returns("MockScanner");
        mock.Setup(s => s.ScanAsync(It.IsAny<Stream>(), It.IsAny<string>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(MalwareScanResult.MalwareFound("MockScanner", threatName, threatType, TimeSpan.FromMilliseconds(100)));
        return mock;
    }

    /// <summary>
    /// Creates a mock scanner that is unavailable.
    /// </summary>
    public static Mock<IMalwareScanner> CreateMockUnavailableScanner()
    {
        var mock = new Mock<IMalwareScanner>();
        mock.Setup(s => s.IsAvailable).Returns(false);
        mock.Setup(s => s.ScannerName).Returns("MockScanner");
        mock.Setup(s => s.ScanAsync(It.IsAny<Stream>(), It.IsAny<string>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(MalwareScanResult.Error("MockScanner", "Scanner not available", TimeSpan.Zero));
        return mock;
    }

    /// <summary>
    /// Creates a mock scanner that times out.
    /// </summary>
    public static Mock<IMalwareScanner> CreateMockTimeoutScanner()
    {
        var mock = new Mock<IMalwareScanner>();
        mock.Setup(s => s.IsAvailable).Returns(true);
        mock.Setup(s => s.ScannerName).Returns("MockScanner");
        mock.Setup(s => s.ScanAsync(It.IsAny<Stream>(), It.IsAny<string>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(MalwareScanResult.Timeout("MockScanner", TimeSpan.FromSeconds(30)));
        return mock;
    }

    /// <summary>
    /// Creates a mock scanner that returns an error.
    /// </summary>
    public static Mock<IMalwareScanner> CreateMockErrorScanner(string errorMessage = "Scan failed")
    {
        var mock = new Mock<IMalwareScanner>();
        mock.Setup(s => s.IsAvailable).Returns(true);
        mock.Setup(s => s.ScannerName).Returns("MockScanner");
        mock.Setup(s => s.ScanAsync(It.IsAny<Stream>(), It.IsAny<string>(), It.IsAny<CancellationToken>()))
            .ReturnsAsync(MalwareScanResult.Error("MockScanner", errorMessage, TimeSpan.FromMilliseconds(50)));
        return mock;
    }

    /// <summary>
    /// Creates a configured mock scanner with custom behavior.
    /// </summary>
    public static Mock<IMalwareScanner> CreateMockScanner(bool isClean, string? threatName = null, string? threatType = null)
    {
        if (isClean)
            return CreateMockCleanScanner();
        
        return CreateMockInfectedScanner(threatName ?? "Unknown.Threat", threatType ?? "Malware");
    }
}
