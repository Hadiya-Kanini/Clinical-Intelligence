using ClinicalIntelligence.Api.Configuration;
using ClinicalIntelligence.Api.Services.Security;
using ClinicalIntelligence.Api.Tests.Helpers;
using Microsoft.Extensions.Logging;
using Moq;
using Xunit;

namespace ClinicalIntelligence.Api.Tests.Services.Security;

/// <summary>
/// Unit tests for malware scanner implementations (US_048).
/// Tests Windows Defender and ClamAV scanner output parsing and behavior.
/// </summary>
public class MalwareScannerTests
{
    #region MalwareScanResult Tests

    [Fact]
    public void MalwareScanResult_Clean_ReturnsCorrectProperties()
    {
        // Act
        var result = MalwareScanResult.Clean("TestScanner", TimeSpan.FromSeconds(1));

        // Assert
        Assert.True(result.IsClean);
        Assert.False(result.IsMalwareDetected);
        Assert.Null(result.ThreatName);
        Assert.Null(result.ThreatType);
        Assert.Equal("TestScanner", result.ScannerName);
        Assert.True(result.ScanCompleted);
        Assert.False(result.TimedOut);
    }

    [Fact]
    public void MalwareScanResult_MalwareFound_ReturnsCorrectProperties()
    {
        // Act
        var result = MalwareScanResult.MalwareFound("TestScanner", "Trojan.Test", "Trojan", TimeSpan.FromSeconds(2));

        // Assert
        Assert.False(result.IsClean);
        Assert.True(result.IsMalwareDetected);
        Assert.Equal("Trojan.Test", result.ThreatName);
        Assert.Equal("Trojan", result.ThreatType);
        Assert.Equal("TestScanner", result.ScannerName);
        Assert.True(result.ScanCompleted);
    }

    [Fact]
    public void MalwareScanResult_Error_ReturnsCorrectProperties()
    {
        // Act
        var result = MalwareScanResult.Error("TestScanner", "Connection failed", TimeSpan.FromMilliseconds(100));

        // Assert
        Assert.False(result.IsClean);
        Assert.False(result.IsMalwareDetected);
        Assert.Equal("Connection failed", result.ErrorMessage);
        Assert.False(result.ScanCompleted);
    }

    [Fact]
    public void MalwareScanResult_Timeout_ReturnsCorrectProperties()
    {
        // Act
        var result = MalwareScanResult.Timeout("TestScanner", TimeSpan.FromSeconds(30));

        // Assert
        Assert.False(result.IsClean);
        Assert.False(result.IsMalwareDetected);
        Assert.True(result.TimedOut);
        Assert.False(result.ScanCompleted);
        Assert.Equal("Scan timed out", result.ErrorMessage);
    }

    #endregion

    #region WindowsDefenderScanner Tests

    [Fact]
    public void WindowsDefenderScanner_IsAvailable_ReturnsFalseWhenDisabled()
    {
        // Arrange
        var loggerMock = new Mock<ILogger<WindowsDefenderScanner>>();
        var options = new MalwareScannerOptions { EnableScanning = false };

        // Act
        var scanner = new WindowsDefenderScanner(loggerMock.Object, options);

        // Assert
        Assert.False(scanner.IsAvailable);
        Assert.Equal("WindowsDefender", scanner.ScannerName);
    }

    [Fact]
    public async Task WindowsDefenderScanner_ScanAsync_ReturnsErrorWhenNotAvailable()
    {
        // Arrange
        var loggerMock = new Mock<ILogger<WindowsDefenderScanner>>();
        var options = new MalwareScannerOptions { EnableScanning = false };
        var scanner = new WindowsDefenderScanner(loggerMock.Object, options);

        using var stream = MalwareTestHelpers.CreateCleanPdfStream();

        // Act
        var result = await scanner.ScanAsync(stream, "test.pdf");

        // Assert
        Assert.False(result.ScanCompleted);
        Assert.Contains("not available", result.ErrorMessage);
    }

    #endregion

    #region ClamAvScanner Tests

    [Fact]
    public void ClamAvScanner_IsAvailable_ReturnsFalseWhenDisabled()
    {
        // Arrange
        var loggerMock = new Mock<ILogger<ClamAvScanner>>();
        var options = new MalwareScannerOptions { EnableScanning = false };

        // Act
        var scanner = new ClamAvScanner(loggerMock.Object, options);

        // Assert
        Assert.False(scanner.IsAvailable);
        Assert.Equal("ClamAV", scanner.ScannerName);
    }

    [Fact]
    public void ClamAvScanner_IsAvailable_ReturnsFalseWhenHostNotConfigured()
    {
        // Arrange
        var loggerMock = new Mock<ILogger<ClamAvScanner>>();
        var options = new MalwareScannerOptions 
        { 
            EnableScanning = true,
            ClamAvHost = null 
        };

        // Act
        var scanner = new ClamAvScanner(loggerMock.Object, options);

        // Assert
        Assert.False(scanner.IsAvailable);
    }

    [Fact]
    public async Task ClamAvScanner_ScanAsync_ReturnsErrorWhenNotAvailable()
    {
        // Arrange
        var loggerMock = new Mock<ILogger<ClamAvScanner>>();
        var options = new MalwareScannerOptions { EnableScanning = false };
        var scanner = new ClamAvScanner(loggerMock.Object, options);

        using var stream = MalwareTestHelpers.CreateCleanPdfStream();

        // Act
        var result = await scanner.ScanAsync(stream, "test.pdf");

        // Assert
        Assert.False(result.ScanCompleted);
        Assert.Contains("not available", result.ErrorMessage);
    }

    #endregion

    #region Mock Scanner Integration Tests

    [Fact]
    public async Task MockScanner_CleanFile_ReturnsIsCleanTrue()
    {
        // Arrange
        var scanner = MalwareTestHelpers.CreateMockCleanScanner();
        using var stream = MalwareTestHelpers.CreateCleanPdfStream();

        // Act
        var result = await scanner.Object.ScanAsync(stream, "clean.pdf");

        // Assert
        Assert.True(result.IsClean);
        Assert.False(result.IsMalwareDetected);
    }

    [Fact]
    public async Task MockScanner_InfectedFile_ReturnsMalwareDetected()
    {
        // Arrange
        var scanner = MalwareTestHelpers.CreateMockInfectedScanner("Eicar-Test-Signature", "Test");
        using var stream = MalwareTestHelpers.CreateEicarTestStream();

        // Act
        var result = await scanner.Object.ScanAsync(stream, "eicar.com");

        // Assert
        Assert.False(result.IsClean);
        Assert.True(result.IsMalwareDetected);
        Assert.Equal("Eicar-Test-Signature", result.ThreatName);
        Assert.Equal("Test", result.ThreatType);
    }

    [Fact]
    public async Task MockScanner_Unavailable_ReturnsError()
    {
        // Arrange
        var scanner = MalwareTestHelpers.CreateMockUnavailableScanner();
        using var stream = MalwareTestHelpers.CreateCleanPdfStream();

        // Act
        var result = await scanner.Object.ScanAsync(stream, "test.pdf");

        // Assert
        Assert.False(result.ScanCompleted);
        Assert.Contains("not available", result.ErrorMessage);
    }

    [Fact]
    public async Task MockScanner_Timeout_ReturnsScanTimeoutError()
    {
        // Arrange
        var scanner = MalwareTestHelpers.CreateMockTimeoutScanner();
        using var stream = MalwareTestHelpers.CreateCleanPdfStream();

        // Act
        var result = await scanner.Object.ScanAsync(stream, "test.pdf");

        // Assert
        Assert.True(result.TimedOut);
        Assert.False(result.ScanCompleted);
    }

    #endregion

    #region EICAR Test File Tests

    [Fact]
    public void EicarTestFile_HasCorrectContent()
    {
        // Act
        var content = MalwareTestHelpers.CreateEicarTestFile();
        var contentString = System.Text.Encoding.ASCII.GetString(content);

        // Assert
        Assert.Equal(MalwareTestHelpers.EicarTestString, contentString);
        Assert.Equal(68, content.Length); // EICAR test file is exactly 68 bytes
    }

    [Fact]
    public void EicarTestStream_CanBeRead()
    {
        // Act
        using var stream = MalwareTestHelpers.CreateEicarTestStream();

        // Assert
        Assert.True(stream.CanRead);
        Assert.Equal(68, stream.Length);
    }

    #endregion
}
