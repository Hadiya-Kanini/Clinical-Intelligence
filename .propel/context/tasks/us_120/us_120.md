# User Story - US_120

## Quick Reference Schema
```yaml
# User Story:
  * ID: [US_120]
  * Title: [Foreign Key Constraints & Referential Integrity]
## Description:
   * [As a developer, I want all foreign key constraints defined and enforced across the 16 tables, so that data integrity is maintained and orphaned records are prevented.]
## Acceptance Criteria:
   * [Given baseline tables exist, When FK constraints are applied, Then all relationships from ERD are enforced]
   * [Given FK constraint exists, When parent record is deleted, Then appropriate cascade or restrict behavior is applied]
   * [Given FK constraint exists, When invalid foreign key is inserted, Then constraint violation error is returned]
## Edge Cases:
   * [What happens when FK references non-existent record? Clear constraint violation error]
   * [How does system handle circular dependencies? Proper ordering of constraint creation]
## Traceability:
### Parent:
    * [EP-DB-001]
### Tags:
    * [DR-002, Database, Integrity, Backend]
### Dependencies:
    * [US_119 - Baseline Schema Migration]
```
---

## Story ID
   * ID Format: US_120

## Story Title
   * Foreign Key Constraints and Referential Integrity Enforcement

## Description
  * As a developer, I want all foreign key constraints defined and enforced across the 16 tables, so that data integrity is maintained, orphaned records are prevented, and relationships between entities are properly validated.

## Acceptance Criteria
  * **AC-1**: Given baseline tables exist, When FK constraints are applied, Then all relationships from ERD are enforced:
    - SESSION.user_id → USER.id
    - PASSWORD_RESET_TOKEN.user_id → USER.id
    - DOCUMENT_BATCH.patient_id → PATIENT.id
    - DOCUMENT_BATCH.uploaded_by_user_id → USER.id
    - DOCUMENT.patient_id → PATIENT.id
    - DOCUMENT.document_batch_id → DOCUMENT_BATCH.id
    - DOCUMENT.uploaded_by_user_id → USER.id
    - PROCESSING_JOB.document_id → DOCUMENT.id
    - DOCUMENT_CHUNK.document_id → DOCUMENT.id
    - EXTRACTED_ENTITY.patient_id → PATIENT.id
    - EXTRACTED_ENTITY.document_id → DOCUMENT.id
    - EXTRACTED_ENTITY.verified_by_user_id → USER.id (nullable)
    - ENTITY_CITATION.extracted_entity_id → EXTRACTED_ENTITY.id
    - ENTITY_CITATION.document_chunk_id → DOCUMENT_CHUNK.id
    - CONFLICT.patient_id → PATIENT.id
    - CONFLICT_RESOLUTION.conflict_id → CONFLICT.id
    - CONFLICT_RESOLUTION.resolved_by_user_id → USER.id
    - CODE_SUGGESTION.patient_id → PATIENT.id
    - CODE_SUGGESTION.extracted_entity_id → EXTRACTED_ENTITY.id
    - CODE_SUGGESTION.code → BILLING_CODE_CATALOG_ITEM.code
    - CODE_SUGGESTION.decided_by_user_id → USER.id (nullable)
    - AUDIT_LOG_EVENT.user_id → USER.id (nullable for system events)
    - AUDIT_LOG_EVENT.session_id → SESSION.id (nullable)
    - VECTOR_QUERY_LOG.user_id → USER.id
    - VECTOR_QUERY_LOG.patient_id → PATIENT.id
  * **AC-2**: Given FK constraint exists on DOCUMENT.patient_id, When patient is soft-deleted (is_deleted=true), Then documents remain accessible but patient cannot be hard-deleted while documents exist
  * **AC-3**: Given FK constraint exists, When an INSERT with invalid foreign key is attempted, Then PostgreSQL returns constraint violation error with clear message
  * **AC-4**: Given CASCADE DELETE is configured on SESSION.user_id, When user is deleted, Then all associated sessions are automatically deleted
  * **AC-5**: Given RESTRICT is configured on PATIENT.id, When patient deletion is attempted with existing documents, Then deletion is blocked with referential integrity error

## Edge Cases
   * What happens when FK references non-existent record? PostgreSQL returns clear constraint violation error identifying the missing parent record
   * How does system handle circular dependencies? Constraints are created in proper order; deferred constraints used where necessary
   * What happens when bulk insert contains mixed valid/invalid FKs? Transaction fails atomically; no partial inserts
   * How does system handle nullable FK columns? NULL values are allowed; constraint only enforced for non-null values
   * What happens when parent table is truncated? TRUNCATE CASCADE must be explicitly specified; otherwise blocked by FK constraints

## Traceability
### Parent Epic
    * Epic: EP-DB-001 - Database Infrastructure & Schema Initialization

### Requirement Tags
    * DR-002 (Enforce referential integrity across users, documents, chunks, entities)
    * Database, Integrity, Backend

### Dependencies
    * US_119 - Baseline Schema Migration (16 Tables)

## Effort Estimation
   * **Story Points**: 3
   * **Estimated Hours**: 24 hours
   * **Complexity**: Medium - Multiple FK relationships with varying cascade behaviors
