# Task - [TASK_001]

## Requirement Reference
- User Story: [us_048]
- Story Location: [.propel/context/tasks/us_048/us_048.md]
- Acceptance Criteria: 
    - Given a file is uploaded, When processed, Then it is scanned for viruses and malware (TR-018).
    - Given malware is detected, When found, Then the file is quarantined and rejected with appropriate error (FR-015g).
    - Given malware detection, When triggered, Then the event is logged with file details for investigation.
    - Given the user, When their file is rejected for malware, Then they receive a clear notification.

## Task Overview
Implement a malware scanning service that integrates with Windows Defender or ClamAV to scan uploaded files for viruses and malicious content before processing. The service must quarantine infected files, log detection events for security investigation, and return clear error messages to users.

This task builds on the existing `DocumentService.cs` validation pipeline and adds:
1. Malware scanning integration via Windows Defender CLI or ClamAV
2. Quarantine workflow for infected files
3. Security audit logging for malware detection events
4. Configurable scanner options for different environments

## Dependent Tasks
- [US_046/task_001] - Backend file format, MIME type, and size validation
- [US_047/task_001] - Backend password-protected and corrupted file detection

## Impacted Components
- [CREATE | Server/ClinicalIntelligence.Api/Services/Security/IMalwareScanner.cs | Interface for malware scanning abstraction]
- [CREATE | Server/ClinicalIntelligence.Api/Services/Security/WindowsDefenderScanner.cs | Windows Defender CLI integration]
- [CREATE | Server/ClinicalIntelligence.Api/Services/Security/ClamAvScanner.cs | ClamAV integration for cross-platform support]
- [CREATE | Server/ClinicalIntelligence.Api/Configuration/MalwareScannerOptions.cs | Configuration options for scanner selection]
- [MODIFY | Server/ClinicalIntelligence.Api/Contracts/FileValidationErrorCode.cs | Add MalwareDetected error code]
- [MODIFY | Server/ClinicalIntelligence.Api/Services/DocumentService.cs | Integrate malware scanning into validation pipeline]
- [MODIFY | Server/ClinicalIntelligence.Api/Program.cs | Register malware scanner services and configuration]

## Implementation Plan

### 1. Define Malware Scanner Interface
```csharp
public interface IMalwareScanner
{
    Task<MalwareScanResult> ScanAsync(Stream fileStream, string fileName, CancellationToken ct);
    bool IsAvailable { get; }
}

public record MalwareScanResult
{
    public bool IsClean { get; init; }
    public bool IsMalwareDetected { get; init; }
    public string? ThreatName { get; init; }
    public string? ThreatType { get; init; }
    public string ScannerName { get; init; } = string.Empty;
    public TimeSpan ScanDuration { get; init; }
    public string? ErrorMessage { get; init; }
}
```

### 2. Create Configuration Options
```csharp
public class MalwareScannerOptions
{
    public const string SectionName = "MalwareScanner";
    
    public string ScannerType { get; set; } = "WindowsDefender"; // WindowsDefender, ClamAV, None
    public string QuarantinePath { get; set; } = "./storage/quarantine";
    public int ScanTimeoutSeconds { get; set; } = 30;
    public bool EnableScanning { get; set; } = true;
    public string? ClamAvHost { get; set; }
    public int ClamAvPort { get; set; } = 3310;
}
```

### 3. Implement Windows Defender Scanner
```csharp
public class WindowsDefenderScanner : IMalwareScanner
{
    // Use MpCmdRun.exe for scanning
    // Parse output for threat detection
    // Handle timeout and error scenarios
    
    private async Task<MalwareScanResult> RunDefenderScanAsync(string filePath, CancellationToken ct)
    {
        // Execute: MpCmdRun.exe -Scan -ScanType 3 -File <path>
        // Parse exit code: 0 = clean, 2 = threat found
        // Extract threat name from output
    }
}
```

### 4. Implement ClamAV Scanner (Cross-Platform)
```csharp
public class ClamAvScanner : IMalwareScanner
{
    // Connect to ClamAV daemon via TCP
    // Send INSTREAM command with file data
    // Parse response for threat detection
    
    private async Task<MalwareScanResult> ScanViaClamdAsync(Stream stream, CancellationToken ct)
    {
        // Connect to clamd on configured host:port
        // Send: zINSTREAM\0
        // Send: <length><data> chunks
        // Send: <0000> to end
        // Parse response: "stream: OK" or "stream: <threat> FOUND"
    }
}
```

### 5. Add MalwareDetected Error Code
```csharp
public enum FileValidationErrorCode
{
    // ... existing codes
    MalwareDetected = 20,        // TR-018, FR-015g: Malware/virus detected
    ScannerUnavailable = 21,     // Scanner service not available
    ScanTimeout = 22             // Scan exceeded timeout
}
```

### 6. Implement Quarantine Workflow
```csharp
private async Task QuarantineFileAsync(string originalPath, string threatName, CancellationToken ct)
{
    // Move file to quarantine directory
    // Create quarantine metadata file with:
    //   - Original filename
    //   - Threat name
    //   - Detection timestamp
    //   - User who uploaded
    // Log MALWARE_DETECTED audit event
}
```

### 7. Update DocumentService Validation Pipeline
```csharp
public async Task<UploadAcknowledgmentResponse> ValidateAndAcknowledgeAsync(...)
{
    // 1. Basic validation (size, extension, MIME) - from US_046
    // 2. Document integrity validation - from US_047
    // 3. Malware scan (NEW)
    //    - Save to temp location
    //    - Run malware scan
    //    - If infected: quarantine, log, return error
    //    - If clean: proceed
    // 4. Return first failure with specific error
}
```

### 8. Audit Logging for Malware Detection
```csharp
// Log MALWARE_DETECTED event with:
// - User ID
// - Original filename
// - File hash (SHA256)
// - Threat name
// - Threat type
// - Scanner used
// - IP address
// - Timestamp
```

## Current Project State
```
Server/ClinicalIntelligence.Api/
├── Services/
│   ├── Security/
│   │   └── (existing security services)
│   └── DocumentService.cs          # Has validation pipeline
├── Configuration/
│   └── (existing options classes)
├── Contracts/
│   └── FileValidationErrorCode.cs  # Error codes
```

## Expected Changes
| Action | File Path | Description |
|--------|-----------|-------------|
| CREATE | Server/ClinicalIntelligence.Api/Services/Security/IMalwareScanner.cs | Interface and result types for malware scanning |
| CREATE | Server/ClinicalIntelligence.Api/Services/Security/WindowsDefenderScanner.cs | Windows Defender CLI integration |
| CREATE | Server/ClinicalIntelligence.Api/Services/Security/ClamAvScanner.cs | ClamAV daemon integration |
| CREATE | Server/ClinicalIntelligence.Api/Configuration/MalwareScannerOptions.cs | Scanner configuration options |
| MODIFY | Server/ClinicalIntelligence.Api/Contracts/FileValidationErrorCode.cs | Add MalwareDetected, ScannerUnavailable, ScanTimeout codes |
| MODIFY | Server/ClinicalIntelligence.Api/Services/DocumentService.cs | Integrate malware scanning, quarantine workflow |
| MODIFY | Server/ClinicalIntelligence.Api/Program.cs | Register IMalwareScanner with appropriate implementation |

## External References
- https://learn.microsoft.com/en-us/microsoft-365/security/defender-endpoint/command-line-arguments-microsoft-defender-antivirus
- https://docs.clamav.net/manual/Usage/Scanning.html
- https://github.com/tekmaven/nClam (ClamAV .NET client reference)

## Build Commands
- dotnet build Server/ClinicalIntelligence.Api
- dotnet test Server/ClinicalIntelligence.Api.Tests

## Implementation Validation Strategy
- [Automated] Unit tests verify IMalwareScanner interface contract
- [Automated] Unit tests verify Windows Defender scanner output parsing
- [Automated] Unit tests verify ClamAV scanner protocol implementation
- [Automated] Unit tests verify quarantine workflow creates correct files
- [Automated] Unit tests verify audit logging for malware detection
- [Automated] Integration tests verify scanner unavailable handling
- [Manual] Test with EICAR test file (standard antivirus test file)
- [Manual] Verify quarantine directory structure and metadata

## Implementation Checklist
- [x] Create IMalwareScanner interface with MalwareScanResult record
- [x] Create MalwareScannerOptions configuration class
- [x] Implement WindowsDefenderScanner with MpCmdRun.exe integration
- [x] Implement ClamAvScanner with clamd TCP protocol
- [x] Add MalwareDetected, ScannerUnavailable, ScanTimeout to FileValidationErrorCode
- [x] Implement quarantine workflow with metadata file creation
- [x] Update DocumentService to integrate malware scanning
- [x] Add audit logging for MALWARE_DETECTED events
- [x] Register scanner services in DI container with configuration
- [x] Add appsettings.json configuration section for MalwareScanner
