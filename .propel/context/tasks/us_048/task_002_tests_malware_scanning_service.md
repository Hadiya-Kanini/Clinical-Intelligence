# Task - [TASK_002]

## Requirement Reference
- User Story: [us_048]
- Story Location: [.propel/context/tasks/us_048/us_048.md]
- Acceptance Criteria: 
    - Given a file is uploaded, When processed, Then it is scanned for viruses and malware (TR-018).
    - Given malware is detected, When found, Then the file is quarantined and rejected with appropriate error (FR-015g).
    - Given malware detection, When triggered, Then the event is logged with file details for investigation.
    - Given the user, When their file is rejected for malware, Then they receive a clear notification.

## Task Overview
Create comprehensive unit and integration tests for the malware scanning service implemented in task_001. Tests must verify scanner interface contracts, Windows Defender and ClamAV implementations, quarantine workflow, audit logging, and error handling scenarios.

## Dependent Tasks
- [US_048/task_001] - Backend malware scanning service implementation

## Impacted Components
- [CREATE | Server/ClinicalIntelligence.Api.Tests/Services/Security/WindowsDefenderScannerTests.cs | Unit tests for Windows Defender scanner]
- [CREATE | Server/ClinicalIntelligence.Api.Tests/Services/Security/ClamAvScannerTests.cs | Unit tests for ClamAV scanner]
- [CREATE | Server/ClinicalIntelligence.Api.Tests/Services/Security/MalwareScannerIntegrationTests.cs | Integration tests for scanner pipeline]
- [CREATE | Server/ClinicalIntelligence.Api.Tests/Services/DocumentServiceMalwareScanTests.cs | Tests for DocumentService malware integration]

## Implementation Plan

### 1. Windows Defender Scanner Tests
```csharp
public class WindowsDefenderScannerTests
{
    [Fact]
    public async Task ScanAsync_CleanFile_ReturnsIsCleanTrue()
    
    [Fact]
    public async Task ScanAsync_InfectedFile_ReturnsMalwareDetectedWithThreatName()
    
    [Fact]
    public async Task ScanAsync_ScannerNotAvailable_ReturnsErrorResult()
    
    [Fact]
    public async Task ScanAsync_Timeout_ReturnsScanTimeoutError()
    
    [Fact]
    public async Task ScanAsync_ParsesDefenderOutput_ExtractsThreatName()
    
    [Fact]
    public async Task IsAvailable_DefenderInstalled_ReturnsTrue()
    
    [Fact]
    public async Task IsAvailable_DefenderNotInstalled_ReturnsFalse()
}
```

### 2. ClamAV Scanner Tests
```csharp
public class ClamAvScannerTests
{
    [Fact]
    public async Task ScanAsync_CleanFile_ReturnsIsCleanTrue()
    
    [Fact]
    public async Task ScanAsync_InfectedFile_ReturnsMalwareDetectedWithThreatName()
    
    [Fact]
    public async Task ScanAsync_DaemonUnavailable_ReturnsErrorResult()
    
    [Fact]
    public async Task ScanAsync_ConnectionTimeout_ReturnsScanTimeoutError()
    
    [Fact]
    public async Task ScanAsync_ParsesClamdResponse_OK()
    
    [Fact]
    public async Task ScanAsync_ParsesClamdResponse_FOUND()
    
    [Fact]
    public async Task ScanAsync_LargeFile_StreamsCorrectly()
}
```

### 3. Quarantine Workflow Tests
```csharp
public class QuarantineWorkflowTests
{
    [Fact]
    public async Task QuarantineFile_MovesFileToQuarantineDirectory()
    
    [Fact]
    public async Task QuarantineFile_CreatesMetadataFile()
    
    [Fact]
    public async Task QuarantineFile_MetadataContainsThreatName()
    
    [Fact]
    public async Task QuarantineFile_MetadataContainsOriginalFilename()
    
    [Fact]
    public async Task QuarantineFile_MetadataContainsTimestamp()
    
    [Fact]
    public async Task QuarantineFile_MetadataContainsUserId()
}
```

### 4. DocumentService Malware Integration Tests
```csharp
public class DocumentServiceMalwareScanTests
{
    [Fact]
    public async Task ValidateAndAcknowledge_CleanFile_ReturnsIsValidTrue()
    
    [Fact]
    public async Task ValidateAndAcknowledge_InfectedFile_ReturnsIsValidFalse()
    
    [Fact]
    public async Task ValidateAndAcknowledge_InfectedFile_ReturnsMalwareDetectedError()
    
    [Fact]
    public async Task ValidateAndAcknowledge_InfectedFile_QuarantinesFile()
    
    [Fact]
    public async Task ValidateAndAcknowledge_ScannerUnavailable_ReturnsAppropriateError()
    
    [Fact]
    public async Task ValidateAndAcknowledge_ScanTimeout_ReturnsScanTimeoutError()
    
    [Fact]
    public async Task ValidateAndAcknowledge_InfectedFile_LogsAuditEvent()
}
```

### 5. Audit Logging Tests
```csharp
public class MalwareAuditLoggingTests
{
    [Fact]
    public async Task MalwareDetected_LogsMALWARE_DETECTED_Event()
    
    [Fact]
    public async Task MalwareDetected_LogContainsUserId()
    
    [Fact]
    public async Task MalwareDetected_LogContainsThreatName()
    
    [Fact]
    public async Task MalwareDetected_LogContainsFileHash()
    
    [Fact]
    public async Task MalwareDetected_LogContainsIpAddress()
}
```

### 6. Integration Tests
```csharp
public class MalwareScannerIntegrationTests : IClassFixture<WebApplicationFactory<Program>>
{
    [Fact]
    public async Task UploadDocument_WithEicarTestFile_ReturnsUnprocessableEntity()
    
    [Fact]
    public async Task UploadDocument_WithCleanPdf_ReturnsOk()
    
    [Fact]
    public async Task UploadDocument_MalwareDetected_ResponseContainsErrorCode()
    
    [Fact]
    public async Task UploadDocument_MalwareDetected_ResponseContainsUserFriendlyMessage()
}
```

### 7. Test Fixtures and Helpers
```csharp
public static class MalwareTestHelpers
{
    // EICAR test string - standard antivirus test pattern
    public const string EicarTestString = "X5O!P%@AP[4\\PZX54(P^)7CC)7}$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!$H+H*";
    
    public static byte[] CreateEicarTestFile()
    {
        return Encoding.ASCII.GetBytes(EicarTestString);
    }
    
    public static Stream CreateCleanPdfStream()
    {
        // Create minimal valid PDF content
    }
    
    public static Mock<IMalwareScanner> CreateMockScanner(bool isClean, string? threatName = null)
    {
        // Create configured mock scanner
    }
}
```

## Current Project State
```
Server/ClinicalIntelligence.Api.Tests/
├── Services/
│   └── (existing service tests)
├── Endpoints/
│   └── UploadAcknowledgmentTests.cs
```

## Expected Changes
| Action | File Path | Description |
|--------|-----------|-------------|
| CREATE | Server/ClinicalIntelligence.Api.Tests/Services/Security/WindowsDefenderScannerTests.cs | Unit tests for Windows Defender scanner |
| CREATE | Server/ClinicalIntelligence.Api.Tests/Services/Security/ClamAvScannerTests.cs | Unit tests for ClamAV scanner |
| CREATE | Server/ClinicalIntelligence.Api.Tests/Services/Security/QuarantineWorkflowTests.cs | Tests for quarantine functionality |
| CREATE | Server/ClinicalIntelligence.Api.Tests/Services/DocumentServiceMalwareScanTests.cs | Tests for DocumentService malware integration |
| CREATE | Server/ClinicalIntelligence.Api.Tests/Services/Security/MalwareAuditLoggingTests.cs | Tests for audit logging |
| CREATE | Server/ClinicalIntelligence.Api.Tests/Endpoints/MalwareScannerIntegrationTests.cs | Integration tests for upload endpoint |
| CREATE | Server/ClinicalIntelligence.Api.Tests/Helpers/MalwareTestHelpers.cs | Test fixtures and helper methods |

## External References
- https://en.wikipedia.org/wiki/EICAR_test_file
- https://xunit.net/docs/getting-started/netcore/cmdline
- https://learn.microsoft.com/en-us/aspnet/core/test/integration-tests

## Build Commands
- dotnet build Server/ClinicalIntelligence.Api.Tests
- dotnet test Server/ClinicalIntelligence.Api.Tests --filter "FullyQualifiedName~Malware"

## Implementation Validation Strategy
- [Automated] All unit tests pass with mocked dependencies
- [Automated] Integration tests verify end-to-end malware scanning flow
- [Automated] Code coverage >= 80% for malware scanning components
- [Manual] Verify EICAR test file triggers detection in integration environment

## Implementation Checklist
- [x] Create MalwareTestHelpers with EICAR test file and mock factories
- [x] Implement WindowsDefenderScannerTests with output parsing tests
- [x] Implement ClamAvScannerTests with protocol tests
- [x] Implement QuarantineWorkflowTests for file operations
- [x] Implement DocumentServiceMalwareScanTests for integration
- [x] Implement MalwareAuditLoggingTests for security events
- [x] Implement MalwareScannerIntegrationTests for API endpoint
- [x] Verify all tests pass with `dotnet test`
