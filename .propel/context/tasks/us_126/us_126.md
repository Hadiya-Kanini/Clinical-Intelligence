# User Story - US_126

## Quick Reference Schema
```yaml
# User Story:
  * ID: [US_126]
  * Title: [Row-Level Security for Document Chunks]
## Description:
   * [As a developer, I want row-level security (RLS) configured on the document_chunks table, so that vector similarity searches only return chunks the requesting user is authorized to access.]
## Acceptance Criteria:
   * [Given RLS is enabled on document_chunks, When user queries vectors, Then only chunks from documents they uploaded or have access to are returned]
   * [Given RLS policy exists, When similarity search is performed, Then unauthorized chunks are filtered at database level]
   * [Given admin user queries, When RLS is evaluated, Then admin can access all chunks for administrative purposes]
## Edge Cases:
   * [What happens when RLS policy is bypassed? Ensure application role cannot bypass RLS]
   * [How does system handle RLS performance impact? Optimize policy predicates with proper indexing]
## Traceability:
### Parent:
    * [EP-DB-001]
### Tags:
    * [DR-005, NFR-005, TR-014, Security, Database, Backend]
### Dependencies:
    * [US_119 - Baseline Schema Migration, US_120 - Foreign Key Constraints]
```
---

## Story ID
   * ID Format: US_126

## Story Title
   * Row-Level Security for Document Chunks Table

## Description
  * As a developer, I want row-level security (RLS) configured on the document_chunks table, so that vector similarity searches and chunk retrieval only return data the requesting user is authorized to access, preventing PHI leakage through embedding queries.

## Acceptance Criteria
  * **AC-1**: Given RLS is enabled on document_chunks table, When Standard User performs vector similarity search, Then only chunks from documents belonging to patients they have access to are returned
  * **AC-2**: Given RLS policy is active, When similarity search query is executed, Then unauthorized chunks are filtered at the PostgreSQL level before results are returned to the application
  * **AC-3**: Given Admin user performs query, When RLS policy is evaluated, Then Admin can access all chunks across all patients for administrative and audit purposes
  * **AC-4**: Given RLS is configured, When application connects with standard role, Then RLS policies are automatically enforced without application-level filtering
  * **AC-5**: Given document is soft-deleted (is_deleted=true), When chunk query is performed, Then chunks from deleted documents are excluded from results
  * **AC-6**: Given RLS policy uses current_user or session variable, When user context is set via `SET app.current_user_id`, Then policy correctly filters based on the authenticated user

## Edge Cases
   * What happens when RLS policy is bypassed? Ensure application database role does not have BYPASSRLS privilege; only superuser can bypass
   * How does system handle RLS performance impact? Create index on document_chunks.document_id and documents.uploaded_by_user_id to optimize policy predicate evaluation
   * What happens when user context is not set? Query fails with clear error indicating missing user context; prevent returning all rows
   * How does system handle batch operations by AI Worker? AI Worker uses service account with appropriate permissions; document worker access patterns
   * What happens when RLS policy has circular dependency? Design policy to avoid joins back to document_chunks; use materialized access control table if needed

## Traceability
### Parent Epic
    * Epic: EP-DB-001 - Database Infrastructure & Schema Initialization

### Requirement Tags
    * DR-005 (Row-level security for document chunks by user permissions)
    * NFR-005 (Encrypt PHI at rest; prevent unauthorized access)
    * TR-014 (Enforce Admin vs Standard role separation)
    * Security, Database, Backend

### Dependencies
    * US_119 - Baseline Schema Migration (16 Tables)
    * US_120 - Foreign Key Constraints & Referential Integrity

## Effort Estimation
   * **Story Points**: 4
   * **Estimated Hours**: 32 hours
   * **Complexity**: High - Security-critical feature requiring careful policy design and testing
