# User Story - US_119

## Quick Reference Schema
```yaml
# User Story:
  * ID: [US_119]
  * Title: [Baseline Schema Migration - 16 Core Tables]
## Description:
   * [As a developer, I want the baseline database schema created with all 16 core tables from the ERD, so that the application has the foundational data structures for users, patients, documents, entities, and audit logging.]
## Acceptance Criteria:
   * [Given EF Core is configured, When baseline migration is applied, Then all 16 tables are created: USER, SESSION, PASSWORD_RESET_TOKEN, PATIENT, DOCUMENT_BATCH, DOCUMENT, PROCESSING_JOB, DOCUMENT_CHUNK, EXTRACTED_ENTITY, ENTITY_CITATION, CONFLICT, CONFLICT_RESOLUTION, BILLING_CODE_CATALOG_ITEM, CODE_SUGGESTION, AUDIT_LOG_EVENT, VECTOR_QUERY_LOG]
   * [Given tables are created, When schema is inspected, Then all columns match ERD specifications with correct data types]
   * [Given vector column exists, When embedding is stored, Then 768-dimensional vector is persisted correctly]
## Edge Cases:
   * [What happens when table already exists? Migration must be idempotent]
   * [How does system handle partial migration failure? Transaction rollback with state recovery]
## Traceability:
### Parent:
    * [EP-DB-001]
### Tags:
    * [DR-001, DR-002, TR-005, Database, Schema, Backend]
### Dependencies:
    * [US_118 - Entity Framework Core Migrations Setup]
```
---

## Story ID
   * ID Format: US_119

## Story Title
   * Baseline Schema Migration Creating 16 Core Tables

## Description
  * As a developer, I want the baseline database schema created with all 16 core tables from the ERD, so that the application has the foundational data structures for users, patients, documents, extracted entities, conflicts, billing codes, and audit logging.

## Acceptance Criteria
  * **AC-1**: Given EF Core is configured, When baseline migration is applied, Then all 16 tables are created:
    - USER (id, email, password_hash, name, role, status, failed_login_attempts, locked_until, is_deleted, deleted_at, created_at, updated_at)
    - SESSION (id, user_id, user_agent, ip_address, is_revoked, created_at, expires_at, last_activity_at)
    - PASSWORD_RESET_TOKEN (id, user_id, token_hash, expires_at, used_at)
    - PATIENT (id, mrn, name, dob, address, contact, is_deleted, deleted_at, created_at, updated_at)
    - DOCUMENT_BATCH (id, patient_id, uploaded_by_user_id, uploaded_at)
    - DOCUMENT (id, patient_id, document_batch_id, uploaded_by_user_id, original_name, mime_type, size_bytes, storage_path, status, is_deleted, deleted_at, uploaded_at)
    - PROCESSING_JOB (id, document_id, status, retry_count, error_message, error_details, processing_time_ms, started_at, completed_at)
    - DOCUMENT_CHUNK (id, document_id, page, section, coordinates, text_content, embedding, token_count, chunk_hash)
    - EXTRACTED_ENTITY (id, patient_id, document_id, category, name, value, units, confidence_score, is_verified, verified_by_user_id, verified_at, effective_at)
    - ENTITY_CITATION (id, extracted_entity_id, document_chunk_id, page, section, coordinates, cited_text)
    - CONFLICT (id, patient_id, field, entity_category, conflicting_values, severity, status, detected_at)
    - CONFLICT_RESOLUTION (id, conflict_id, resolved_by_user_id, resolved_value, resolved_at)
    - BILLING_CODE_CATALOG_ITEM (code, code_type, description)
    - CODE_SUGGESTION (id, patient_id, extracted_entity_id, code, code_type, source_text, status, decided_by_user_id, suggested_at, decided_at)
    - AUDIT_LOG_EVENT (id, user_id, session_id, action_type, ip_address, user_agent, resource_type, resource_id, metadata, timestamp, integrity_hash)
    - VECTOR_QUERY_LOG (id, user_id, patient_id, query_text, result_count, response_time_ms, timestamp, query_hash)
  * **AC-2**: Given tables are created, When schema is inspected, Then all columns match ERD specifications with correct PostgreSQL data types (uuid, varchar, text, timestamp, jsonb, vector(768))
  * **AC-3**: Given DOCUMENT_CHUNK table exists, When a 768-dimensional embedding vector is stored, Then the vector is persisted and retrievable correctly
  * **AC-4**: Given USER table exists, When email uniqueness is tested, Then duplicate emails are rejected with constraint violation
  * **AC-5**: Given migration is complete, When `\dt` is executed in psql, Then all 16 tables are listed with correct ownership

## Edge Cases
   * What happens when table already exists from previous partial run? Migration must be idempotent and skip existing tables or use IF NOT EXISTS
   * How does system handle partial migration failure? Full transaction rollback with detailed error logging and state recovery guidance
   * What happens when vector extension is not enabled? Migration must check for pgvector and fail with clear prerequisite error
   * How does system handle reserved word conflicts in column names? Use proper quoting or rename columns to avoid conflicts
   * What happens when disk space is insufficient during migration? Pre-flight check with estimated space requirements

## Traceability
### Parent Epic
    * Epic: EP-DB-001 - Database Infrastructure & Schema Initialization

### Requirement Tags
    * DR-001 (FHIR-aligned patient-centric schema)
    * DR-002 (Referential integrity)
    * TR-005 (pgvector storage)
    * Database, Schema, Backend

### Dependencies
    * US_118 - Entity Framework Core Migrations Setup

## Effort Estimation
   * **Story Points**: 5
   * **Estimated Hours**: 40 hours
   * **Complexity**: High - Large schema with multiple entity types and vector support
